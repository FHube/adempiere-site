"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[84188],{98573:(e,n,a)=>{a.r(n),a.d(n,{default:()=>p});var s=a(34086);const r=(0,s._)("p",null,[(0,s.Uk)("在 HTML 表单中，可以上传文件的唯一控件就是 "),(0,s._)("code",null,'<input type="file">'),(0,s.Uk)("。")],-1),t=(0,s.uE)('<div class="custom-container warning"><p class="custom-container-title">注意</p><p>当一个表单包含 <code>&lt;input type=&quot;file&quot;&gt;</code> 时，表单的 <code>enctype</code> 必须指定为 <code>multipart/form-data</code>，<code>method</code> 必须指定为 <code>post</code>，浏览器才能正确编码并以 <code>multipart/form-data</code> 格式发送表单的数据。</p></div><p>出于安全考虑，浏览器只允许用户点击 <code>&lt;input type=&quot;file&quot;&gt;</code> 来选择本地文件，用 JavaScript 对 <code>&lt;input type=&quot;file&quot;&gt;</code> 的 <code>value</code> 赋值是没有任何效果的。当用户选择了上传某个文件后，JavaScript 也无法获得该文件的真实路径:</p><p>通常，上传的文件都由后台服务器处理，JavaScript 可以在提交表单时对文件扩展名做检查，以便防止用户上传无效格式的文件:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>const f = document.querySelector(&quot;#test-file-upload&quot;);\nconst filename = f.value; // &#39;C:\\fakepath\\test.png&#39;\n\nif (\n  !filename ||\n  !(\n    filename.endsWith(&quot;.jpg&quot;) ||\n    filename.endsWith(&quot;.png&quot;) ||\n    filename.endsWith(&quot;.gif&quot;)\n  )\n) {\n  alert(&quot;Can only upload image file.&quot;);\n  return false;\n}\n</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="file-api" tabindex="-1"><a class="header-anchor" href="#file-api" aria-hidden="true">#</a> File API</h2><p>由于 JavaScript 对用户上传的文件操作非常有限，尤其是无法读取文件内容，使得很多需要操作文件的网页不得不用 Flash 这样的第三方插件来实现。</p><p>随着 HTML5 的普及，新增的 File API 允许 JavaScript 读取文件内容，获得更多的文件信息。</p><p>HTML5 的 File API 提供了 <code>File</code> 和 <code>FileReader</code> 两个主要对象，可以获得文件信息并读取文件。</p><p>下面的例子演示了如何读取用户选取的图片文件，并在一个 <code>&lt;div&gt;</code> 中预览图像:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>const fileInput = document.querySelector(&quot;#test-image-file&quot;);\nconst info = document.querySelector(&quot;#test-file-info&quot;);\nconst preview = document.querySelector(&quot;#test-image-preview&quot;);\n\n// 监听change事件:\nfileInput.addEventListener(&quot;change&quot;, () =&gt; {\n  // 清除背景图片:\n  preview.style.backgroundImage = &quot;&quot;;\n  // 检查文件是否选择:\n  if (!fileInput.value) {\n    info.innerHTML = &quot;没有选择文件&quot;;\n    return;\n  }\n  // 获取File引用:\n  const file = fileInput.files[0];\n\n  // 获取File信息:\n  info.innerHTML = `文件: ${file.name}&lt;br&gt;大小: ${file.size}&lt;br&gt;修改: ${file.lastModifiedDate}`;\n\n  if (\n    file.type !== &quot;image/jpeg&quot; &amp;&amp;\n    file.type !== &quot;image/png&quot; &amp;&amp;\n    file.type !== &quot;image/gif&quot;\n  ) {\n    alert(&quot;不是有效的图片文件!&quot;);\n    return;\n  }\n  // 读取文件:\n  const reader = new FileReader();\n\n  reader.onload = (e) =&gt; {\n    const data = e.target.result; // &#39;data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...&#39;\n\n    preview.style.backgroundImage = `url(${data})`;\n  };\n  // 以DataURL的形式读取文件:\n  reader.readAsDataURL(file);\n});\n</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>上面的代码演示了如何通过 HTML5 的 File API 读取文件内容。以 DataURL 的形式读取到的文件是一个字符串，类似于 <code>data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...</code>，常用于设置图像。如果需要服务器端处理，把字符串 <code>base64</code>,后面的字符发送给服务器并用 base64 解码就可以得到原始文件的二进制内容。</p><h2 id="回调" tabindex="-1"><a class="header-anchor" href="#回调" aria-hidden="true">#</a> 回调</h2><p>上面的代码还演示了 JavaScript 的一个重要的特性就是单线程执行模式。在 JavaScript 中，浏览器的 JavaScript 执行引擎在执行 JavaScript 代码时，总是以单线程模式执行，也就是说，任何时候，JavaScript 代码都不可能同时有多于 <code>1</code> 个线程在执行。</p><p>您可能会问，单线程模式执行的 JavaScript，如何处理多任务?</p><p>在 JavaScript 中，执行多任务实际上都是异步调用，比如上面的代码:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>reader.readAsDataURL(file);\n</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>就会发起一个异步操作来读取文件内容。因为是异步操作，所以我们在 JavaScript 代码中就不知道什么时候操作结束，因此需要先设置一个回调函数:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>reader.onload = (e) =&gt; {\n  // 当文件读取完成后，自动调用此函数:\n};\n</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当文件读取完成后，JavaScript 引擎将自动调用我们设置的回调函数。执行回调函数时，文件已经读取完毕，所以我们可以在回调函数内部安全地获得文件内容。</p>',19),l={},p=(0,a(82831).Z)(l,[["render",function(e,n){return(0,s.wg)(),(0,s.iD)(s.HY,null,[r,(0,s.kq)(" more "),t],64)}]])},82831:(e,n)=>{n.Z=(e,n)=>{const a=e.__vccOpts||e;for(const[e,s]of n)a[e]=s;return a}},38922:(e,n,a)=>{a.r(n),a.d(n,{data:()=>s});const s={key:"v-fb7c1444",path:"/code/language/js/browser/file.html",title:"操作文件",lang:"zh-CN",frontmatter:{title:"操作文件",icon:"file",date:"2019-10-17T00:00:00.000Z",category:["JavaScript"],summary:"在 HTML 表单中，可以上传文件的唯一控件就是 &lt;input type=&quot;file&quot;&gt;。\n",head:[["meta",{property:"og:url",content:"https://mrhope.site/code/language/js/browser/file.html"}],["meta",{property:"og:site_name",content:"Mr.Hope"}],["meta",{property:"og:title",content:"操作文件"}],["meta",{property:"og:type",content:"article"}],["meta",{property:"og:updated_time",content:"2022-02-06T16:46:58.000Z"}],["meta",{property:"og:locale",content:"zh-CN"}],["meta",{property:"article:published_time",content:"2019-10-17T00:00:00.000Z"}],["meta",{property:"article:modified_time",content:"2022-02-06T16:46:58.000Z"}]]},excerpt:"<p>在 HTML 表单中，可以上传文件的唯一控件就是 <code v-pre>&lt;input type=&quot;file&quot;&gt;</code>。</p>\n",headers:[{level:2,title:"File API",slug:"file-api",children:[]},{level:2,title:"回调",slug:"回调",children:[]}],git:{createdTime:1591204114e3,updatedTime:1644166018e3,contributors:[{name:"Mr.Hope",email:"zhangbowang1998@gmail.com",commits:7}]},readingTime:{minutes:2.95,words:886},filePathRelative:"code/language/js/browser/file.md"}}}]);